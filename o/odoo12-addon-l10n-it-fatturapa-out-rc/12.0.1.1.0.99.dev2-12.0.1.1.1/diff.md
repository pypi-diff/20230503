# Comparing `tmp/odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2-py3-none-any.whl.zip` & `tmp/odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,27 +1,27 @@
-Zip file size: 33830 bytes, number of entries: 25
--rw-r--r--  2.0 unx     3448 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/README.rst
--rw-r--r--  2.0 unx       42 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/__init__.py
--rw-r--r--  2.0 unx      816 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/__manifest__.py
--rw-r--r--  2.0 unx     4905 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/i18n/it.po
--rw-r--r--  2.0 unx     3625 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/i18n/l10n_it_fatturapa_out_rc.pot
--rw-r--r--  2.0 unx       52 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/models/__init__.py
--rw-r--r--  2.0 unx     1454 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/models/account_invoice.py
--rw-r--r--  2.0 unx      298 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/models/rc_type.py
--rw-r--r--  2.0 unx      307 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONFIGURE.rst
--rw-r--r--  2.0 unx       61 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      198 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx     9455 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/static/description/icon.png
--rw-r--r--  2.0 unx    12902 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/static/description/index.html
--rw-r--r--  2.0 unx       36 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/tests/__init__.py
--rw-r--r--  2.0 unx    11387 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/tests/test_e_invoice_out_rc.py
--rw-r--r--  2.0 unx     3554 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00002.xml
--rw-r--r--  2.0 unx     3559 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00003.xml
--rw-r--r--  2.0 unx     3559 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00004.xml
--rw-r--r--  2.0 unx      489 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/views/rc_type_views.xml
--rw-r--r--  2.0 unx       38 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/wizard/__init__.py
--rw-r--r--  2.0 unx     9777 b- defN 23-Apr-27 05:00 odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py
--rw-r--r--  2.0 unx     4260 b- defN 23-Apr-27 05:03 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Apr-27 05:03 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Apr-27 05:03 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2913 b- defN 23-Apr-27 05:03 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/RECORD
-25 files, 77232 bytes uncompressed, 28788 bytes compressed:  62.7%
+Zip file size: 34967 bytes, number of entries: 25
+-rw-r--r--  2.0 unx     3448 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/README.rst
+-rw-r--r--  2.0 unx       42 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/__init__.py
+-rw-r--r--  2.0 unx      816 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/__manifest__.py
+-rw-r--r--  2.0 unx     4905 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/i18n/it.po
+-rw-r--r--  2.0 unx     3629 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/i18n/l10n_it_fatturapa_out_rc.pot
+-rw-r--r--  2.0 unx       52 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/models/__init__.py
+-rw-r--r--  2.0 unx     1454 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/models/account_invoice.py
+-rw-r--r--  2.0 unx      298 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/models/rc_type.py
+-rw-r--r--  2.0 unx      307 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONFIGURE.rst
+-rw-r--r--  2.0 unx       61 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      198 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx     9455 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/static/description/icon.png
+-rw-r--r--  2.0 unx    12902 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/static/description/index.html
+-rw-r--r--  2.0 unx       36 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/tests/__init__.py
+-rw-r--r--  2.0 unx    16198 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/tests/test_e_invoice_out_rc.py
+-rw-r--r--  2.0 unx     3554 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00002.xml
+-rw-r--r--  2.0 unx     3559 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00003.xml
+-rw-r--r--  2.0 unx     3559 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00004.xml
+-rw-r--r--  2.0 unx      489 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/views/rc_type_views.xml
+-rw-r--r--  2.0 unx       38 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/wizard/__init__.py
+-rw-r--r--  2.0 unx    11550 b- defN 23-May-03 19:58 odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py
+-rw-r--r--  2.0 unx     4252 b- defN 23-May-03 19:58 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-03 19:58 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-May-03 19:58 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2882 b- defN 23-May-03 19:58 odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/RECORD
+25 files, 83781 bytes uncompressed, 29989 bytes compressed:  64.2%
```

## zipnote {}

```diff
@@ -57,20 +57,20 @@
 
 Filename: odoo/addons/l10n_it_fatturapa_out_rc/wizard/__init__.py
 Comment: 
 
 Filename: odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py
 Comment: 
 
-Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/METADATA
+Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/METADATA
 Comment: 
 
-Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/WHEEL
+Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/WHEEL
 Comment: 
 
-Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/top_level.txt
+Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/RECORD
+Filename: odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/l10n_it_fatturapa_out_rc/__manifest__.py

```diff
@@ -1,13 +1,13 @@
 # Copyright 2020 Lorenzo Battistini @ TAKOBI
 # License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl).
 {
     "name": "ITA - Emissione e-fattura con reverse charge",
     "summary": "Integrazione l10n_it_fatturapa_out e l10n_it_reverse_charge",
-    "version": "12.0.1.1.0",
+    "version": "12.0.1.1.1",
     "development_status": "Beta",
     "category": "Hidden",
     "website": "https://github.com/OCA/l10n-italy"
                "/tree/12.0/l10n_it_fatturapa_out_rc",
     "author": "TAKOBI, Odoo Community Association (OCA)",
     "maintainers": ["eLBati"],
     "license": "AGPL-3",
```

## odoo/addons/l10n_it_fatturapa_out_rc/i18n/l10n_it_fatturapa_out_rc.pot

```diff
@@ -10,21 +10,21 @@
 "Language-Team: \n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: \n"
 "Plural-Forms: \n"
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:68
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:111
 #, python-format
 msgid "A self-invoice cannot be issued with IT country code and fiscal document type in 'TD17', 'TD18', 'TD19'."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:74
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:117
 #, python-format
 msgid "Country code does not exist or it is not mapped in countries: %s"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
 #: model:ir.model,name:l10n_it_fatturapa_out_rc.model_wizard_export_fatturapa
 msgid "Export E-invoice"
@@ -32,67 +32,67 @@
 
 #. module: l10n_it_fatturapa_out_rc
 #: model:ir.model.fields,field_description:l10n_it_fatturapa_out_rc.field_account_rc_type__fiscal_document_type_id
 msgid "Fiscal Document Type"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:85
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:128
 #, python-format
 msgid "Impossible to set IdFiscaleIVA for %s"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
 #: model:ir.model,name:l10n_it_fatturapa_out_rc.model_account_invoice
 msgid "Invoice"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:100
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:143
 #, python-format
 msgid "Partner %s, City is not set."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:103
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:146
 #, python-format
 msgid "Partner %s, Country is not set."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:97
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:140
 #, python-format
 msgid "Partner %s, Street is not set."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:115
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:158
 #, python-format
 msgid "Partner %s, ZIP is not set."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
 #: model:ir.model,name:l10n_it_fatturapa_out_rc.model_account_rc_type
 msgid "Reverse Charge Type"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:38
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:69
 #, python-format
 msgid "Select invoices are of too many fiscal document types: select invoices exclusively of type 'TD17', 'TD18', 'TD19' or exclusively of other types."
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:28
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:56
 #, python-format
 msgid "Selected invoices are both with and without reverse charge. You should selected a smaller set of invoices"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
-#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:45
+#: code:addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py:79
 #, python-format
 msgid "Selected reverse charge invoices have different suppliers. Please select invoices with same supplier"
 msgstr ""
 
 #. module: l10n_it_fatturapa_out_rc
 #: model:ir.model.fields,help:l10n_it_fatturapa_out_rc.field_account_rc_type__fiscal_document_type_id
 msgid "To be used when sending self invoices to the exchange system"
```

## odoo/addons/l10n_it_fatturapa_out_rc/tests/test_e_invoice_out_rc.py

```diff
@@ -1,11 +1,12 @@
 import base64
 from odoo.addons.l10n_it_reverse_charge.tests.rc_common import ReverseChargeCommon
 from odoo.addons.l10n_it_fatturapa_out.tests.fatturapa_common import FatturaPACommon
 from odoo.exceptions import UserError
+from odoo.tests import Form
 
 
 class TestReverseCharge(ReverseChargeCommon, FatturaPACommon):
 
     def setUp(self):
         super(TestReverseCharge, self).setUp()
         self.company = self.rc_type_ieu.company_id
@@ -236,7 +237,113 @@
         self.supplier_extraEU.country_id = self.env.ref("base.us")
         res = self.run_wizard(invoice.rc_self_invoice_id.id)
         attachment = self.attach_model.browse(res['res_id'])
         self.set_e_invoice_file_id(attachment, 'IT10538570960_00004.xml')
         xml_content = base64.decodebytes(attachment.datas)
         self.check_content(
             xml_content, 'IT10538570960_00004.xml', "l10n_it_fatturapa_out_rc")
+
+    def _configure_be_supplier(self, supplier):
+        supplier_form = Form(supplier)
+        supplier_form.property_payment_term_id = self.term_15_30
+        supplier_form.vat = "BE0477472701"
+        supplier_form.street = "Street"
+        supplier_form.zip = "12345"
+        supplier_form.city = "city"
+        supplier_form.country_id = self.env.ref("base.be")
+        supplier = supplier_form.save()
+        return supplier
+
+    def _create_rc_bill(self, supplier, tax):
+        bill_model = self.invoice_model.with_context(type='in_invoice')
+        bill_form = Form(bill_model)
+        bill_form.partner_id = supplier
+        bill_form.date_invoice = '2020-12-01'
+        with bill_form.invoice_line_ids.new() as line:
+            line.name = 'Bill for sample product'
+            line.product_id = self.sample_product
+            line.invoice_line_tax_ids.clear()
+            line.invoice_line_tax_ids.add(tax)
+        bill = bill_form.save()
+        bill.action_invoice_open()
+        return bill
+
+    def test_intra_EU_multiple_suppliers(self):
+        """
+        Export multiple self-invoices coming from different suppliers.
+        """
+        # Arrange: Create 2 self invoices from 2 supplier bills
+        # having different suppliers
+        be_supplier = self._configure_be_supplier(self.supplier_intraEU)
+        be_bill = self._create_rc_bill(be_supplier, self.tax_22ai)
+        be_self_invoice = be_bill.rc_self_invoice_id
+        self.assertTrue(be_self_invoice)
+
+        bg_supplier = be_supplier.copy(default={
+            'vat': 'BG1234567892',
+            'country_id': self.env.ref("base.bg").id,
+        })
+        bg_bill = be_bill.copy(default={
+            'partner_id': bg_supplier.id,
+        })
+        bg_bill.action_invoice_open()
+        bg_self_invoice = bg_bill.rc_self_invoice_id
+        self.assertTrue(bg_self_invoice)
+        # pre-condition: The self-invoices are linked to different suppliers
+        self_invoices = be_self_invoice | bg_self_invoice
+        original_suppliers = self_invoices._get_original_suppliers()
+        self.assertEqual(len(original_suppliers), 2)
+        self.assertItemsEqual(original_suppliers, be_supplier | bg_supplier)
+
+        # Act: Export the self-invoices
+        result_action = self.run_wizard(self_invoices.ids)
+
+        # Assert: 2 different attachments have been created
+        result_model = result_action.get('res_model')
+        result_domain = result_action.get('domain')
+        result_records = self.env[result_model].search(result_domain)
+        self.assertEqual(len(result_records), 2)
+
+    def test_extra_EU_multiple_suppliers_additional_invoice(self):
+        """
+        Export multiple self-invoices coming from different suppliers.
+        The Reverse Charge Type applied
+        has "With additional supplier self invoice" enabled.
+        """
+        # Arrange: Create 2 self invoices from 2 supplier bills
+        # having different suppliers.
+        # Both supplier bills have "With additional supplier self invoice" enabled
+        be_supplier = self._configure_be_supplier(self.supplier_extraEU)
+        be_bill = self._create_rc_bill(be_supplier, self.tax_0_pur)
+        fiscal_position = be_bill.fiscal_position_id
+        reverse_charge_type = fiscal_position.rc_type_id
+        self.assertTrue(reverse_charge_type.with_supplier_self_invoice)
+        be_self_invoice = be_bill.rc_self_purchase_invoice_id.rc_self_invoice_id
+        self.assertTrue(be_self_invoice)
+
+        bg_supplier = be_supplier.copy(default={
+            'vat': 'BG1234567892',
+            'country_id': self.env.ref("base.bg").id,
+        })
+        bg_bill = be_bill.copy(default={
+            'partner_id': bg_supplier.id,
+        })
+        bg_bill.action_invoice_open()
+        fiscal_position = bg_bill.fiscal_position_id
+        reverse_charge_type = fiscal_position.rc_type_id
+        self.assertTrue(reverse_charge_type.with_supplier_self_invoice)
+        bg_self_invoice = bg_bill.rc_self_purchase_invoice_id.rc_self_invoice_id
+        self.assertTrue(bg_self_invoice)
+        # pre-condition: The self-invoices are linked to different suppliers
+        self_invoices = be_self_invoice | bg_self_invoice
+        original_suppliers = self_invoices._get_original_suppliers()
+        self.assertEqual(len(original_suppliers), 2)
+        self.assertItemsEqual(original_suppliers, be_supplier | bg_supplier)
+
+        # Act: Export the self-invoices
+        result_action = self.run_wizard(self_invoices.ids)
+
+        # Assert: 2 different attachments have been created
+        result_model = result_action.get('res_model')
+        result_domain = result_action.get('domain')
+        result_records = self.env[result_model].search(result_domain)
+        self.assertEqual(len(result_records), 2)
```

## odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py

```diff
@@ -2,53 +2,96 @@
 from odoo.exceptions import UserError
 from odoo.addons.l10n_it_account.tools.account_tools import encode_for_export
 from odoo.addons.l10n_it_fatturapa.bindings.fatturapa import (
     IdFiscaleType,
     AnagraficaType,
     IndirizzoType
 )
+from odoo.fields import first
 
 
 class WizardExportFatturapa(models.TransientModel):
     _inherit = "wizard.export.fatturapa"
 
-    def exportInvoiceXML(
-        self, company, partner, invoice_ids, attach=False, context=None
-    ):
-        if context is None:
-            context = {}
+    def group_invoices_by_partner(self):
+        """
+        Group Reverse charge self-invoices one by one.
+
+        We are sending invoices to ourselves,
+        and XMLs containing self-invoices are currently managed as
+        if there was one self-invoice in each XML
+        (see `fatturapa.attachment.in.is_self_invoice`
+        and `fatturapa.attachment.in.linked_invoice_id_xml`)
+        """
+        invoice_ids = self.env.context.get('active_ids', False)
+        invoices = self._get_rc_invoices(invoice_ids)
+        invoices_with_rc, _other_invoices = self._split_rc_invoices(invoices)
+        if invoices == invoices_with_rc:
+            # These are self-invoices, they are all for ourselves
+            partner = first(invoices_with_rc).partner_id
+            invoices_by_partner = {
+                partner: [
+                    invoice_with_rc.ids
+                    for invoice_with_rc in invoices_with_rc
+                ],
+            }
+        else:
+            invoices_by_partner = super().group_invoices_by_partner()
+        return invoices_by_partner
+
+    def _split_rc_invoices(self, invoices):
+        invoices_with_rc = invoices.filtered('rc_purchase_invoice_id')
+        invoices_without_rc = invoices - invoices_with_rc
+        return invoices_with_rc, invoices_without_rc
+
+    def _get_rc_invoices(self, invoice_ids):
+        """
+        Return the invoices having IDs `invoice_ids`,
+        if they satisfy Reverse Charge constraints;
+        otherwise raise an Exception.
+        """
         invoices = self.env["account.invoice"].browse(invoice_ids)
-        invoices_with_rc = False
-        invoices_without_rc = False
-        for invoice in invoices:
-            if invoice.rc_purchase_invoice_id:
-                invoices_with_rc = True
-            else:
-                invoices_without_rc = True
+        # All the invoices are either self-invoices or not
+        invoices_with_rc, invoices_without_rc = self._split_rc_invoices(invoices)
         if invoices_with_rc and invoices_without_rc:
             raise UserError(_(
                 "Selected invoices are both with and without reverse charge. You "
                 "should selected a smaller set of invoices"))
+
+        # All the invoices either have specific fiscal document types or not
+        fiscal_document_codes = ['TD17', 'TD18', 'TD19']
         invoices_fiscal_document_type_codes = invoices.filtered(
-            lambda x: x.fiscal_document_type_id.code in ['TD17', 'TD18', 'TD19']
+            lambda x: x.fiscal_document_type_id.code in fiscal_document_codes
         )
         invoices_fiscal_document_type1_codes = invoices.filtered(
-            lambda x: x.fiscal_document_type_id.code not in ['TD17', 'TD18', 'TD19']
+            lambda x: x.fiscal_document_type_id.code not in fiscal_document_codes
         )
         if invoices_fiscal_document_type_codes and invoices_fiscal_document_type1_codes:
             raise UserError(_(
                 "Select invoices are of too many fiscal document types: "
                 "select invoices exclusively of type 'TD17', 'TD18', 'TD19' "
                 "or exclusively of other types."
             ))
+        return invoices
+
+    def _get_rc_suppliers(self, invoices):
         rc_suppliers = invoices._get_original_suppliers()
         if len(rc_suppliers) > 1:
             raise UserError(_(
                 "Selected reverse charge invoices have different suppliers. Please "
                 "select invoices with same supplier"))
+        return rc_suppliers
+
+    def exportInvoiceXML(
+        self, company, partner, invoice_ids, attach=False, context=None
+    ):
+        if context is None:
+            context = {}
+        invoices = self._get_rc_invoices(invoice_ids)
+        rc_suppliers = self._get_rc_suppliers(invoices)
         if rc_suppliers:
             context['rc_supplier'] = rc_suppliers[0]
             context['invoices_fiscal_document_type_codes'] = invoices.mapped(
                 'fiscal_document_type_id.code')
         return super(WizardExportFatturapa, self).exportInvoiceXML(
             company, partner, invoice_ids, attach, context)
```

## Comparing `odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/METADATA` & `odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo12-addon-l10n-it-fatturapa-out-rc
-Version: 12.0.1.1.0.99.dev2
+Version: 12.0.1.1.1
 Summary: Integrazione l10n_it_fatturapa_out e l10n_it_reverse_charge
 Home-page: https://github.com/OCA/l10n-italy/tree/12.0/l10n_it_fatturapa_out_rc
 Author: TAKOBI, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
```

## Comparing `odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/RECORD` & `odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,25 +1,25 @@
 odoo/addons/l10n_it_fatturapa_out_rc/README.rst,sha256=v2-JgDrG997SPmTpdLVkNx4w73cEA_-wMQINIURDw5s,3448
 odoo/addons/l10n_it_fatturapa_out_rc/__init__.py,sha256=4xA2wEP-VC0HAopaFS8ihQ1VjQDTg34AvIvOmq-alrM,42
-odoo/addons/l10n_it_fatturapa_out_rc/__manifest__.py,sha256=u0DYVjZAjUxFAnYRcCsBC7Nj8MF5pWVSXlDFBTpQcxM,816
+odoo/addons/l10n_it_fatturapa_out_rc/__manifest__.py,sha256=2Dg7orymo7_Mc5XRRSXqzM9hPrJdJulYSo-tgcq4JlI,816
 odoo/addons/l10n_it_fatturapa_out_rc/i18n/it.po,sha256=bl03pSxKhUXt0eKd52wjmU7xjdhl9qYP15HSHoL8fvU,4905
-odoo/addons/l10n_it_fatturapa_out_rc/i18n/l10n_it_fatturapa_out_rc.pot,sha256=OXgxoKRktQh64npjbGi_TXH3dQ17BydDIdiX5YBXDGk,3625
+odoo/addons/l10n_it_fatturapa_out_rc/i18n/l10n_it_fatturapa_out_rc.pot,sha256=WoOza7rLk9YXbUWHgvUnXJI8I6_CLePk47kH1Hclo64,3629
 odoo/addons/l10n_it_fatturapa_out_rc/models/__init__.py,sha256=NX96aObZOVCSohfvTOQcoBa-kEPK0Kl4VQrDWC-6e5c,52
 odoo/addons/l10n_it_fatturapa_out_rc/models/account_invoice.py,sha256=cxx-MBST0pyJXaf11vOXRSZD5fl-sJNUkBsjrE-3cgA,1454
 odoo/addons/l10n_it_fatturapa_out_rc/models/rc_type.py,sha256=Rw6VCydlccqMq-ZtcS_TEof2thrVHmCSe5-D-4AwPXs,298
 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONFIGURE.rst,sha256=slSAvQ_OW_ToHpIx7QbezTOWJp6E9JYjEOz-R8Wny4c,307
 odoo/addons/l10n_it_fatturapa_out_rc/readme/CONTRIBUTORS.rst,sha256=Ki4V3A4CWURKCMIA0omdaHXjFBB-Xrc-BD6jKna-Fsg,61
 odoo/addons/l10n_it_fatturapa_out_rc/readme/DESCRIPTION.rst,sha256=gG4EUXITj0jEuneI7QB3_VSGCu5pUQAu391Eo6xRgdw,198
 odoo/addons/l10n_it_fatturapa_out_rc/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/l10n_it_fatturapa_out_rc/static/description/index.html,sha256=ehcfBYT8jmFQcQbOd4C-QNCg1wfnhpEqzEDqIg3XxRA,12902
 odoo/addons/l10n_it_fatturapa_out_rc/tests/__init__.py,sha256=CxQsGJl1_Rubz_AWRJ9fK_Umhol-s1msMjdE8UmSYi8,36
-odoo/addons/l10n_it_fatturapa_out_rc/tests/test_e_invoice_out_rc.py,sha256=ElJg5dAwRZn1B7wmFcu1dn1JHAiTabiEc89_8Uc5DM8,11387
+odoo/addons/l10n_it_fatturapa_out_rc/tests/test_e_invoice_out_rc.py,sha256=ETwlCCOV_DWdADnGj5R28fCTmync_9JIGIAg8KwxYBg,16198
 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00002.xml,sha256=-To36f2LEPqGg61Xs2teLVoa6c16bMMkHlYHWg0Ay1I,3554
 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00003.xml,sha256=HPSxh_HiXae-yZoJLp3v4qoQnVyedR0wWULMAsKFRw0,3559
 odoo/addons/l10n_it_fatturapa_out_rc/tests/data/IT10538570960_00004.xml,sha256=aC-OZNMg4IGgT0QUURlON_ylfwKqmmAKSU-kYHOjAEE,3559
 odoo/addons/l10n_it_fatturapa_out_rc/views/rc_type_views.xml,sha256=IfSFCRJwqnteAXBRn07Qlvd8Ce1jTsVJU7W9WiJl5LQ,489
 odoo/addons/l10n_it_fatturapa_out_rc/wizard/__init__.py,sha256=oA7Y433A728mcoO-XQ8nTvzqWZK355rkrLIbQ5CmFFM,38
-odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py,sha256=ljcDKXijCmD2MotlSgUFxhwYaZdBOJMsgwTOv7vh6pg,9777
-odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/METADATA,sha256=eCvjaDMex2NBFlj7pnZwrkS3kRkJxcX7rkKO_G7zN34,4260
-odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.0.99.dev2.dist-info/RECORD,,
+odoo/addons/l10n_it_fatturapa_out_rc/wizard/wizard_export_e_invoice.py,sha256=uPqEt1xIAw98iVZr81Qes5uGwiy5U0BkJ2jvFlVLGSg,11550
+odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/METADATA,sha256=JKPlSYjxWRfWrq9gvTL4nbupjfWifS8zYwao8Z0xvro,4252
+odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo12_addon_l10n_it_fatturapa_out_rc-12.0.1.1.1.dist-info/RECORD,,
```

